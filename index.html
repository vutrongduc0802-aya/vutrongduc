<script>
// ========= LOAD dữ liệu =========
let list = JSON.parse(localStorage.getItem("bangdiem")) || [];

let student = JSON.parse(localStorage.getItem("sinhvien")) || {
    masv: "",
    hoten: "",
    lop: "",
    covan: ""
};

// ========= GÁN LÊN INPUT NGAY KHI TẢI TRANG =========
window.onload = () => {
    masv.value = student.masv;
    hoten.value = student.hoten;
    lop.value = student.lop;
    covan.value = student.covan;

    renderInfo();
    render();
};

// ========= Hiển thị thông tin sinh viên =========
function renderInfo() {
    document.getElementById("info").innerHTML = `
        <b>Mã sinh viên:</b> ${student.masv || ""}<br>
        <b>Họ và tên:</b> ${student.hoten || ""}<br>
        <b>Lớp:</b> ${student.lop || ""}<br>
        <b>Cố vấn học tập:</b> ${student.covan || ""}
    `;
}

// ========= Tự lưu thông tin sinh viên =========
function saveStudent() {
    student = {
        masv: masv.value,
        hoten: hoten.value,
        lop: lop.value,
        covan: covan.value
    };

    localStorage.setItem("sinhvien", JSON.stringify(student));
    renderInfo();
}

// LƯU NGAY KHI GÕ
document.querySelectorAll("#masv, #hoten, #lop, #covan")
.forEach(input => {
    input.addEventListener("input", saveStudent);
});

// ========= Định dạng ngày dd/mm/yyyy =========
function formatDate(d) {
    let date = new Date(d);
    if (!d) return "";
    return `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
}

// ========= Tính điểm =========
function tinhDiem10(cc, kt, ck) {
    return (Math.round((cc*0.2 + kt*0.3 + ck*0.5) * 10) / 10).toFixed(1);
}

function diemChu(d) {
    d = Number(d);
    if (d >= 8.5) return "A";
    if (d >= 7.0) return "B";
    if (d >= 5.5) return "C";
    if (d >= 4.0) return "D";
    return "F";
}

function diemHe4(letter) {
    return {A:4, B:3, C:2, D:1, F:0}[letter];
}

// ========= Render bảng điểm =========
function render() {
    const tbody = document.getElementById("data");
    tbody.innerHTML = "";

    list.forEach((r, i) => {
        tbody.innerHTML += `
            <tr>
                <td>${i+1}</td>
                <td>${r.mon}</td>
                <td>${r.hocky}</td>
                <td>${r.tc}</td>
                <td>${r.cc}</td>
                <td>${r.kt}</td>
                <td>${r.ck1}</td>
                <td>${r.ck2}</td>
                <td>${r.d10}</td>
                <td>${r.dchu}</td>
                <td>${r.dhp}</td>
                <td>${r.ngay}</td>
                <td>${r.ghichu}</td>
                <td><button class="delete" onclick="remove(${i})">Xóa</button></td>
            </tr>
        `;
    });

    localStorage.setItem("bangdiem", JSON.stringify(list));
}

// ========= Thêm môn =========
function add() {
    let ckFinal = ck2.value ? ck2.value : ck1.value;

    let d10 = tinhDiem10(cc.value, kt.value, ckFinal);
    let dchu = diemChu(d10);
    let dhp = diemHe4(dchu);

    const row = {
        mon: mon.value,
        hocky: hocky.value,
        tc: sotinchi.value,
        cc: cc.value,
        kt: kt.value,
        ck1: ck1.value,
        ck2: ck2.value,
        d10,
        dchu,
        dhp,
        ngay: formatDate(ngay.value),
        ghichu: ghichu.value
    };

    list.push(row);
    render();

    document.querySelectorAll(".form input").forEach(i => i.value = "");
}

// ========= Xóa môn =========
function remove(i) {
    list.splice(i, 1);
    render();
}
</script>
